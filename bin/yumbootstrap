#!/usr/bin/python

import os
import sys
import optparse
import time

import yumbootstrap.yum
from yumbootstrap.exceptions import YBError

#-----------------------------------------------------------------------------

o = optparse.OptionParser(
  usage = '\n  %prog [options] <suite> <target>'
          '\n  %prog [options] --print-config <suite> <target> > yum.conf'
          '\n  %prog [options] --list-suites'
          '\n  %prog [options] --fix-rpmdb <target>'
          '\n  %prog [options] --cleanup <target>'
          '',
  description = 'Install Yum-based distribution in a chroot environment.',
)

#-----------------------------------------------------------

expected_nargs = {
  'install':     [2],
  'yum.conf':    [2],
  'list_suites': [0],
  'fix_rpmdb':   [1],
  'cleanup':     [1],
  #'download':     [?],
  #'second_stage': [?],
  #'tarball':      [?],
}

o.set_defaults(
  action = 'install',
  include = [],
  exclude = [],
  groups = [],
  repositories = {},
)

def add_pkg_list(option, opt, value, parser, attr):
  getattr(parser.values, attr).extend(value.split(','))

def add_kv_list(option, opt, value, parser, attr):
  if '=' not in value:
    raise optparse.OptionValueError('"%s" is not in NAME=VALUE format' % value)
  (k,v) = value.split('=', 1)
  getattr(parser.values, attr)[k] = v

#-----------------------------------------------------------

# to be filled after o.parse_args()
verbose = False

def op(message, *args):
  if verbose:
    print time.strftime('[%T] ') + (message % args)

#-----------------------------------------------------------

o.add_option(
  '--list-suites',
  action = 'store_const', dest = 'action', const = 'list_suites',
  help = 'list available suites and exit',
)
o.add_option(
  '--print-config',
  action = 'store_const', dest = 'action', const = 'yum.conf',
  help = 'print Yum configuration which will be used by yumbootstrap',
)
o.add_option(
  '--fix-rpmdb',
  action = 'store_const', dest = 'action', const = 'fix_rpmdb',
  help = "fix target's RPM database instead of installing packages"
         " (see --skip-fix-rpmdb)",
)
o.add_option(
  '--cleanup',
  action = 'store_const', dest = 'action', const = 'cleanup',
  help = "remove yumbootstrap config from target instead of installing"
         " packages (see --skip-cleanup)",
)

#-----------------------------------------------------------

o.add_option(
  '--verbose',
  action = 'store_true', default = False,
  help = 'be verbose about operations',
)
o.add_option(
  '--noninteractive',
  action = 'store_false', dest = 'interactive', default = True,
  help = 'run in non-interactive mode (e.g. no progress bars)',
)
#o.add_option(
#  '--arch', # TODO
#  action = 'store', default = os.uname()[4],
#  help = 'specify target architecture',
#)
#o.add_option(
#  '--proxy', # TODO
#  action = 'store', type = 'string', default = None,
#  help = 'specify a proxy to use when fetching files',
#  metavar = 'HOST:PORT',
#)
o.add_option(
  '--include',
  action = 'callback', type = 'string',
  callback = add_pkg_list, callback_args = ('include',),
  help = 'include these packages (comma separated list; may be specified'
         ' multiple times)',
  metavar = 'RPMS',
)
o.add_option(
  '--exclude',
  action = 'callback', type = 'string',
  callback = add_pkg_list, callback_args = ('exclude',),
  help = 'exclude these packages (comma separated list; may be specified'
         ' multiple times)',
  metavar = 'RPMS',
)
o.add_option(
  '--groups',
  action = 'callback', type = 'string',
  callback = add_pkg_list, callback_args = ('groups',),
  help = 'install these package groups (comma separated list; may be specified'
         ' multiple times)',
)
#o.add_option(
#  '--no-default-rpms', # TODO
#  action = 'store_false', dest = 'install_default_rpms', default = True,
#  help = "don't install default RPMs set (useful for splitting installation"
#         " into several parts; see also --skip-fix-rpmdb and --skip-cleanup"
#         " options)",
#)
o.add_option(
  '--gpgkey',
  action = 'append', dest = 'gpg_keys', default = [],
  help = 'add GPG key as a trusted RPM signing key (may be specified'
         ' multiple times)',
  metavar = 'KEYFILE',
)
o.add_option(
  '--repo',
  action = 'callback', type = 'string',
  callback = add_kv_list, callback_args = ('repositories',),
  help = 'use this Yum repository (may be specified multiple times)',
  metavar = 'NAME=URL',
)
o.add_option(
  '--skip-fix-rpmdb',
  action = 'store_false', dest = 'fix_rpmdb', default = True,
  help = "don't fix target's RPM database (`yum --installroot=...'"
         " won't break the chroot)",
)
o.add_option(
  '--skip-cleanup',
  action = 'store_false', dest = 'cleanup', default = True,
  help = "don't remove yumbootstrap config or cache from target",
)
#o.add_option(
#  '--download-only', # TODO
#  action = 'store_const', dest = 'action', const = 'download',
#  help = "download RPMs only, don't install them",
#)
#o.add_option(
#  '--foreign', # TODO
#  action = 'store_true', dest = 'no_scripts', default = False,
#  help = "don't run post-install scripts from RPM (mainly useful for"
#         " non-matching architecture in --arch option)",
#)
#o.add_option(
#  '--second-stage', # TODO
#  action = 'store_const', dest = 'action', const = 'second_stage',
#  help = "finalize the installation started with --foreign option",
#)
#o.add_option(
#  '--make-tarball', # TODO
#  action = 'store_const', dest = 'action', const = 'tarball',
#  help = "make a tarball with RPMs instead of installing them",
#)
#o.add_option(
#  '--unpack-tarball', # TODO
#  action = 'store', dest = 'tarball', default = None,
#  help = "use RPMs from a tarball created with --make-tarball option",
#)

opts, args = o.parse_args()

if len(args) not in expected_nargs[opts.action]:
  o.error("wrong number of arguments")

verbose = opts.verbose

#-----------------------------------------------------------------------------

#-----------------------------------------------------------

def prepare_suite(suite):
  import yumbootstrap.suites

  (suite, version) = suite.split('-', 1)
  if suite == 'centos':
    suite = yumbootstrap.suites.CentOS(version)
  elif suite == 'redhat':
    suite = yumbootstrap.suites.RedHat(version)
  elif suite == 'fedora':
    suite = yumbootstrap.suites.Fedora(version)
  else:
    raise YBError('unrecognized suite: %s', suite)

  return suite

#-----------------------------------------------------------

def do_install(opts, suite, target):
  from yumbootstrap.fs import touch

  suite = prepare_suite(suite)

  op("installing %s (release %s) to %s", suite.name(), suite.version(), target)

  op("preparing empty /etc/fstab and /etc/mtab")
  os.umask(022)
  # prepare target directory with an empty /etc/fstab
  touch(target, 'etc/fstab', text = '# empty fstab')
  touch(target, 'etc/mtab')

  if len(opts.repositories) > 0:
    op("using custom repositories: %s", ", ".join(sorted(opts.repositories)))
    repositories = opts.repositories
  else:
    op("using built-in repositories")
    repositories = suite.repositories()

  yum_conf = yumbootstrap.yum.YumConfig(chroot = target, repos = repositories)

  # installing works also without adding key, but --nogpgcheck is passed to
  # Yum, so it's generally discouraged
  if len(opts.gpg_keys) > 0:
    op("adding GPG keys")
    for keyfile in opts.gpg_keys:
      yum_conf.add_key(keyfile)
  else:
    pass # TODO: print warning

  yum = yumbootstrap.yum.Yum(
    chroot = target,
    yum_conf = yum_conf,
    interactive = opts.interactive,
  )

  # main set of packages (should already include yum and /usr/bin/db_load, so
  # `yum.fix_rpmdb()' works)
  op("installing default packages for %s", suite.name())
  yum.install(suite.packages(), exclude = opts.exclude)

  # requested additional packages
  if len(opts.include) > 0:
    op("installing additional packages requested from command line")
    yum.install(opts.include, exclude = opts.exclude)
  if len(opts.groups) > 0:
    op("installing additional package groups requested from command line")
    yum.group_install(opts.groups, exclude = opts.exclude)

  if opts.fix_rpmdb:
    do_fix_rpmdb(opts, target, yum)
  else:
    op("skipping fixing RPM database")

  if opts.cleanup:
    do_cleanup(opts, target, yum)
  else:
    op("skipping cleanup")

  op("operation finished")

#-----------------------------------------------------------

def do_list_suites(opts):
  suites = {
    #'redhat': ['5', '6'],
    'centos': [
      '5', '5.1', '5.2', '5.3', '5.4', '5.5', '5.6', '5.7', '5.8', '5.9', '5.10',
      '6', '6.1', '6.2', '6.3', '6.4', '6.5',
    ],
    'fedora': [
      '18', '19', '20',
    ],
  }
  for dist in sorted(suites):
    for rel in suites[dist]:
      print "%s-%s" % (dist, rel)

#-----------------------------------------------------------

def do_yum_conf(opts, suite, target):
  suite = prepare_suite(suite)

  if len(opts.repositories) > 0:
    repositories = opts.repositories
  else:
    repositories = suite.repositories()

  yum_conf = yumbootstrap.yum.YumConfig(chroot = target, repos = repositories)

  if len(opts.gpg_keys) > 0:
    cmd = 'cat %s > %s' % (' '.join(opts.gpg_keys), yum_conf.gpg_keys)
    sys.stdout.write('# remember to put the keys to target directory:\n')
    sys.stdout.write('# %s\n\n' % (cmd))
    for keyfile in opts.gpg_keys:
      yum_conf.add_key(keyfile, pretend = True)

  sys.stdout.write(yum_conf.text())
  sys.stdout.flush()

#-----------------------------------------------------------

def do_fix_rpmdb(opts, target, yum = None):
  op("fixing RPM database in target directory")

  if yum is None:
    yum = yumbootstrap.yum.Yum(
      chroot = target,
      interactive = opts.interactive,
    )

  yum.fix_rpmdb()

#-----------------------------------------------------------

def do_cleanup(opts, target, yum = None):
  if yum is None:
    yum = yumbootstrap.yum.Yum(
      chroot = target,
      interactive = opts.interactive,
    )

  op("cleaning up after installation")

  # TODO: remove $target/etc/yumbootstrap.chroot/yum.conf file (now it's
  # removed in yumbootstrap.yum.Yum destructor)
  yum.clean()

#-----------------------------------------------------------

#-----------------------------------------------------------------------------

try:
  if opts.action == 'install':
    do_install(opts, *args)
  elif opts.action == 'list_suites':
    do_list_suites(opts, *args)
  elif opts.action == 'yum.conf':
    do_yum_conf(opts, *args)
  elif opts.action == 'fix_rpmdb':
    do_fix_rpmdb(opts, *args)
  elif opts.action == 'cleanup':
    do_cleanup(opts, *args)
  else:
    # should never happen
    o.error("unrecognized action: %s" % (opts.action,))
except KeyboardInterrupt:
  pass
except YBError, e:
  print >>sys.stderr, e
  sys.exit(e.code)

#-----------------------------------------------------------------------------
# vim:ft=python
